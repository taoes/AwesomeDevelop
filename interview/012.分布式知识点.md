# 分布式知识点
## 负载均衡
1. （加权）轮询
2. （加权） 随机
3. 源地址HASH算法
4. 最少连接算法

## 实现方案
+  Nginx 七层负载均衡
+  F5 硬件负载均衡

## 其他
### 概念区分
+ 集群： 注重物理布局
+ 分布式: 注重工作方式
+ SOA: 面向服务的中心化分布式框架，ESB存在单点
+ 微服务: 基于RestAPI的去中心化的分布式服务
+ 分布式锁注重于互斥区资源的访问，分布式事务则在于ACID的实现

## 分布式事务
事务的操作位于不同的节点上，需要保证事务的 ACID 特性。 eg: 下单和库存处于不同的节点上时候就需要分布式事务

### 【2PC】 二阶段提交
1. 引入协调者，协调者询问参与者是否都执行成功，参与者返回 yes/no。
2. 如果参数这都返回执行成功/失败，那么协调者发送提交/回滚指令。
3. 存在的问题
> + 同步阻塞: 所有事务参与者在等待其它参与者响应的时候都处于同步阻塞等待状态，无法进行其它操作
> + 单点问题:  协调者在 2PC 中起到非常大的作用，发生故障将会造成很大影响。
> + 数据不一致: 在提交阶段，如果协调者只发送了部分 Commit 消息，此时网络发生异常，那么只有部分参与者接收到 Commit 消息，也就是说只有部分参与者提交了事务，使得系统数据不一致
> + 过于保守：任意一个节点失败就会导致整个事务失败，没有完善的容错机制。

### 【3PC】 三阶段提交
1. canCommit
> 1. 协调者向参与者发送CanCommit请求。询问是否可以执行事务提交操作。然后开始等待参与者的响应。
> 2. 响应反馈 参与者接到CanCommit请求之后，正常情况下，如果其自身认为可以顺利执行事务，则返回Yes响应，并进入预备状态。否则反馈No
2. preCommit
3. doCommit

### 总结
 2PC 一致性好、可用性较低，3PC一致性较低、可用性高

## 分布式锁的实现
+  (单机) 互斥量或临界资源实现
+ DataBase 唯一索引： 但其不可重入，无重试机制、超时机制
+ zookeeper: 有序节点
	1.  创建一个锁目录 /lock；
	2.  当一个客户端需要获取锁时，在 /lock 下创建临时的且有序的子节点；
	3.  客户端获取 /lock 下的子节点列表，判断自己创建的子节点是否为当前子节点列表中序号最小的子节点，如果是则认为获得锁；否则监听自己的前一个子节点，获得子节点的变更通知后重复此步骤直至获得锁
	4. 执行业务代码，完成后，删除对应的子节点
+ Redis：
	1. SetNX + Expire
	2. RedLock
	> 1. 尝试从 N 个互相独立 Redis 实例获取锁；
	> 2. 计算获取锁消耗的时间，只有时间小于锁的过期时间，并且从大多数（N / 2 + 1）实例上获取了锁，才认为获取锁成功；
	> 3. 如果获取锁失败，就到每个实例上释放锁

## 分布式概念

### 1、一致性协议

#### 1.1、Paxos

角色: 提议者, 接受者 & 记录者

流程: 

####  1.2、Raft 协议

 主要用于选举

####  1.3、ZAP 协议

等待完善

### 2、相关理论
#### 2.1、CAP  理论
CAP: 一致性、可用性与分区容错性。 CAP中三者只能实现2个，因为P是肯定要有的，所以只能实现CP或者AP。为了保证一致性（CP），不能访问未同步完成的节点，也就失去了部分可用性；为了保证可用性（AP），允许读取所有节点的数据，但是数据可能不一致

####  2.2、BASE 理论
BASE 是基本可用（Basically Available）、软状态（Soft State）和最终一致性（Eventually Consistent）。 基本可用: 可能会出现服务降级等；软状态: 如支付 可能会出现非最终的中间状态, 如支付中，支付查询中等； 最终一致性: 非CAP中的强一致性，这里的一致性值得最终一致性，允许此时短暂时间的内的数据不一致的文图
